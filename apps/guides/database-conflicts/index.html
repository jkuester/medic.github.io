
<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.71.1" />

<META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">



<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/beta/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/beta/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/beta/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/beta/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/beta/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/beta/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/beta/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/beta/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/beta/favicons/android-192x192.png" sizes="192x192">

<title>Database Conflicts | Community Health Toolkit</title><meta property="og:title" content="Database Conflicts" />
<meta property="og:description" content="How to handle conflicts with CouchDB documents
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://docs.communityhealthtoolkit.org/beta/apps/guides/database-conflicts/" />
<meta property="article:modified_time" content="2020-06-04T19:14:59+03:00" /><meta property="og:site_name" content="Community Health Toolkit" />
<meta itemprop="name" content="Database Conflicts">
<meta itemprop="description" content="How to handle conflicts with CouchDB documents
">
<meta itemprop="dateModified" content="2020-06-04T19:14:59&#43;03:00" />
<meta itemprop="wordCount" content="1287">



<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Database Conflicts"/>
<meta name="twitter:description" content="How to handle conflicts with CouchDB documents
"/>





<link rel="preload" href="/beta/scss/main.min.6c9cfbd21677a7e7dbf84cdc0d519aaa8b5ae1e669353f63fd8018abf82a8e2e.css" as="style">
<link href="/beta/scss/main.min.6c9cfbd21677a7e7dbf84cdc0d519aaa8b5ae1e669353f63fd8018abf82a8e2e.css" rel="stylesheet" integrity="">


<script
  src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>

<script
  src="https://unpkg.com/lunr@2.3.8/lunr.min.js"
  integrity="sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY"
  crossorigin="anonymous"></script>


  </head>
  <body class="td-page">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/beta/">
		<span class="navbar-logo"></span><span class="text-uppercase font-weight-bold">Community Health Toolkit</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link active" href="/beta/" ><span class="active">Documentation</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block">


<input
  type="search"
  class="form-control td-search-input"
  placeholder="&#xf002; Search this site…"
  aria-label="Search this site…"
  autocomplete="off"
  
  data-offline-search-index-json-src="/beta/offline-search-index.ac2942ab4b76d821f106bba83b6ce514848582d8eb985b5b75d8cf1314a59836e844a4e5b263bc9ce7d420f824b6d73c075df6b3362653e662158d003c9daa22.json"
  data-offline-search-base-href="/"
>

</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
            





<div id="td-sidebar-menu" class="td-sidebar__inner">
  
  <form class="td-sidebar__search d-flex align-items-center">
    


<input
  type="search"
  class="form-control td-search-input"
  placeholder="&#xf002; Search this site…"
  aria-label="Search this site…"
  autocomplete="off"
  
  data-offline-search-index-json-src="/beta/offline-search-index.ac2942ab4b76d821f106bba83b6ce514848582d8eb985b5b75d8cf1314a59836e844a4e5b263bc9ce7d420f824b6d73c075df6b3362653e662158d003c9daa22.json"
  data-offline-search-base-href="/"
>


    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type="button" data-toggle="collapse" data-target="#td-section-nav" aria-controls="td-docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  
  <nav class="collapse td-sidebar-nav pt-2 pl-4" id="td-section-nav">
    
    
    
    
    
    
    






<ul class="td-sidebar-nav__section pr-md-3">

    <li class="collapse show" id="beta">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betawhy-the-cht" href="/beta/why-the-cht/">Why the CHT?</a>
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">

  <li class="td-sidebar-nav__section-title">
    <a  href="/beta/apps/" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section">CHT Applications</a>
  </li>
  <ul>

    <li class="collapse show" id="betaapps">
      
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">

  <li class="td-sidebar-nav__section-title">
    <a  href="/beta/apps/concepts/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Concepts</a>
  </li>
  <ul>

    <li class="collapse " id="betaappsconcepts">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsconceptsaccess" href="/beta/apps/concepts/access/">Access</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsconceptsnavigation" href="/beta/apps/concepts/navigation/">Navigation</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsconceptsforms" href="/beta/apps/concepts/forms/">Forms</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsconceptscare-guides" href="/beta/apps/concepts/care-guides/">Care Guides</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsconceptsworkflows" href="/beta/apps/concepts/workflows/">Workflows</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsconceptshierarchy" href="/beta/apps/concepts/hierarchy/">Hierarchies</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsconceptsusers" href="/beta/apps/concepts/users/">Users</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsconceptsinteroperability" href="/beta/apps/concepts/interoperability/">Interoperability</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsconceptsprerequisites" href="/beta/apps/concepts/prerequisites/">Prerequisites</a>
      
      
    </li>

  </ul>


</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">

  <li class="td-sidebar-nav__section-title">
    <a  href="/beta/apps/features/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Features</a>
  </li>
  <ul>

    <li class="collapse " id="betaappsfeatures">
      
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">

  <li class="td-sidebar-nav__section-title">
    <a  href="/beta/apps/features/contacts/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Contacts</a>
  </li>
  <ul>

    <li class="collapse " id="betaappsfeaturescontacts">
      
      
      
    </li>

  </ul>


</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">

  <li class="td-sidebar-nav__section-title">
    <a  href="/beta/apps/features/messaging/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Messaging</a>
  </li>
  <ul>

    <li class="collapse " id="betaappsfeaturesmessaging">
      
      
      
    </li>

  </ul>


</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">

  <li class="td-sidebar-nav__section-title">
    <a  href="/beta/apps/features/reports/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Reports</a>
  </li>
  <ul>

    <li class="collapse " id="betaappsfeaturesreports">
      
      
      
    </li>

  </ul>


</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">

  <li class="td-sidebar-nav__section-title">
    <a  href="/beta/apps/features/tasks/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Tasks</a>
  </li>
  <ul>

    <li class="collapse " id="betaappsfeaturestasks">
      
      
      
    </li>

  </ul>


</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">

  <li class="td-sidebar-nav__section-title">
    <a  href="/beta/apps/features/targets/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Targets</a>
  </li>
  <ul>

    <li class="collapse " id="betaappsfeaturestargets">
      
      
      
    </li>

  </ul>


</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">

  <li class="td-sidebar-nav__section-title">
    <a  href="/beta/apps/features/admin/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">App Management</a>
  </li>
  <ul>

    <li class="collapse " id="betaappsfeaturesadmin">
      
      
      
    </li>

  </ul>


</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">

  <li class="td-sidebar-nav__section-title">
    <a  href="/beta/apps/features/integrations/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Integrations</a>
  </li>
  <ul>

    <li class="collapse " id="betaappsfeaturesintegrations">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsfeaturesintegrationsdhis2" href="/beta/apps/features/integrations/dhis2/">DHIS2</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsfeaturesintegrationsopenmrs" href="/beta/apps/features/integrations/openmrs/">OpenMRS</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsfeaturesintegrationsrapidpro" href="/beta/apps/features/integrations/rapidpro/">RapidPro</a>
      
      
    </li>

  </ul>


</ul>

      
      
    </li>

  </ul>


</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">

  <li class="td-sidebar-nav__section-title">
    <a  href="/beta/apps/examples/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Examples</a>
  </li>
  <ul>

    <li class="collapse " id="betaappsexamples">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsexamplesanc" href="/beta/apps/examples/anc/">ANC Reference App</a>
      
      
    </li>

  </ul>


</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">

  <li class="td-sidebar-nav__section-title">
    <a  href="/beta/apps/tutorials/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Tutorials</a>
  </li>
  <ul>

    <li class="collapse " id="betaappstutorials">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappstutorialslocal-setup" href="/beta/apps/tutorials/local-setup/">Local Setup</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappstutorialscontact-and-users-1" href="/beta/apps/tutorials/contact-and-users-1/">Contacts &#43; Users 1</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappstutorialscontact-and-users-2" href="/beta/apps/tutorials/contact-and-users-2/">Contacts &#43; Users 2</a>
      
      
    </li>

  </ul>


</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">

  <li class="td-sidebar-nav__section-title">
    <a  href="/beta/apps/guides/" class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">Quick Guides</a>
  </li>
  <ul>

    <li class="collapse show" id="betaappsguides">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsguidesadditional-docs" href="/beta/apps/guides/additional-docs/">Additional Docs</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsguidesafricas-talking" href="/beta/apps/guides/africas-talking/">Africa&#39;s Talking</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsguidesapp-form-sms" href="/beta/apps/guides/app-form-sms/">App Form SMS</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsguidescontact-forms" href="/beta/apps/guides/contact-forms/">Contact Forms</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsguidescouch2pg-oom-errors" href="/beta/apps/guides/couch2pg-oom-errors/">Couch2pg Memory Errors</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsguidescouchdb-authentication" href="/beta/apps/guides/couchdb-authentication/">CouchDB Authentication</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsguidescsv-to-docs" href="/beta/apps/guides/csv-to-docs/">CSV to Docs</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page  active" id="m-betaappsguidesdatabase-conflicts" href="/beta/apps/guides/database-conflicts/">Database Conflicts</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsguidesdhis2-aggregate" href="/beta/apps/guides/dhis2-aggregate/">DHIS2 Aggregate</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsguidesec2-setup-guide" href="/beta/apps/guides/ec2-setup-guide/">EC2 Setup</a>
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">

  <li class="td-sidebar-nav__section-title">
    <a  href="/beta/apps/guides/gateway/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Gateway</a>
  </li>
  <ul>

    <li class="collapse " id="betaappsguidesgateway">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsguidesgatewayconfiguration" href="/beta/apps/guides/gateway/configuration/">Configuration</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsguidesgatewayphones" href="/beta/apps/guides/gateway/phones/">Phones</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsguidesgatewaytroubleshooting" href="/beta/apps/guides/gateway/troubleshooting/">Troubleshooting</a>
      
      
    </li>

  </ul>


</ul>

      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsguidesinvalid-reports" href="/beta/apps/guides/invalid-reports/">Invalid Reports</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsguidesmessage-loops" href="/beta/apps/guides/message-loops/">Message Loops</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsguidesmoving-contacts" href="/beta/apps/guides/moving-contacts/">Moving Contacts</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsguidesmultimedia" href="/beta/apps/guides/multimedia/">Multimedia in Forms</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsguidesobtaining-logs" href="/beta/apps/guides/obtaining-logs/">Obtaining Logs</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsguidesreplicating-production-data-locally" href="/beta/apps/guides/replicating-production-data-locally/">Production Data</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsguidespurging" href="/beta/apps/guides/purging/">Purging</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsguidesrdbms-in-windows" href="/beta/apps/guides/rdbms-in-windows/">RDBMS in Windows</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsguidescollect-forms-update" href="/beta/apps/guides/collect-forms-update/">Remote Collect Update</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsguidesreplication" href="/beta/apps/guides/replication/">Replication</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsguidesreport-titles" href="/beta/apps/guides/report-titles/">Report Titles</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsguidessecuring-android" href="/beta/apps/guides/securing-android/">Securing Android</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsguidesself-hosting" href="/beta/apps/guides/self-hosting/">Self Hosting</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsguidesshortcodes" href="/beta/apps/guides/shortcodes/">Shortcodes</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsguidesssh-into-docker" href="/beta/apps/guides/ssh-into-docker/">SSH into Docker</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsguidesssl-cert-install" href="/beta/apps/guides/ssl-cert-install/">SSL Cert Install</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsguidestelemetry" href="/beta/apps/guides/telemetry/">Telemetry</a>
      
      
    </li>

  </ul>


</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">

  <li class="td-sidebar-nav__section-title">
    <a  href="/beta/apps/reference/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Reference</a>
  </li>
  <ul>

    <li class="collapse " id="betaappsreference">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsreferencesupported-software" href="/beta/apps/reference/supported-software/">Supported Versions</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsreferenceapp-forms" href="/beta/apps/reference/app-forms/">App Forms</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsreferenceapp-settings" href="/beta/apps/reference/app-settings/">App Settings</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsreferenceapp-settings-validations" href="/beta/apps/reference/app-settings-validations/">App Settings Validations</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsreferencecollect-forms" href="/beta/apps/reference/collect-forms/">Collect Forms</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsreferencecontact-forms" href="/beta/apps/reference/contact-forms/">Contact Forms</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsreferencecontact-page" href="/beta/apps/reference/contact-page/">Contact Pages</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsreferencedhis2" href="/beta/apps/reference/dhis2/">DHIS2</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsreferencefunctions" href="/beta/apps/reference/functions/">Functions</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsreferencegraphics" href="/beta/apps/reference/graphics/">Graphics</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsreferencehierarchy" href="/beta/apps/reference/hierarchy/">Hierarchy</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsreferencejson-forms" href="/beta/apps/reference/json-forms/">JSON Forms</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsreferencelocalization" href="/beta/apps/reference/localization/">Localization</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsreferenceoutbound" href="/beta/apps/reference/outbound/">Outbound</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsreferencereplication" href="/beta/apps/reference/replication/">Replications</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsreferencesms" href="/beta/apps/reference/sms/">SMS settings</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsreferencesms-states" href="/beta/apps/reference/sms-states/">SMS States</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsreferenceworkflows-sms" href="/beta/apps/reference/workflows-sms/">SMS Workflows</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsreferencetargets" href="/beta/apps/reference/targets/">Targets</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsreferencetasks" href="/beta/apps/reference/tasks/">Tasks</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsreferencetransitions" href="/beta/apps/reference/transitions/">Transitions</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsreferenceuser-permissions" href="/beta/apps/reference/user-permissions/">User Permissions</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betaappsreferenceuser-roles" href="/beta/apps/reference/user-roles/">User Roles</a>
      
      
    </li>

  </ul>


</ul>

      
      
    </li>

  </ul>


</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">

  <li class="td-sidebar-nav__section-title">
    <a  href="/beta/core/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">CHT Core Framework</a>
  </li>
  <ul>

    <li class="collapse " id="betacore">
      
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">

  <li class="td-sidebar-nav__section-title">
    <a  href="/beta/core/overview/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Overview</a>
  </li>
  <ul>

    <li class="collapse " id="betacoreoverview">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betacoreoverviewarchitecture" href="/beta/core/overview/architecture/">Architecture</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betacoreoverviewdb-schema" href="/beta/core/overview/db-schema/">Database Schema</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betacoreoverviewdata-flows-for-analytics" href="/beta/core/overview/data-flows-for-analytics/">Data Flows</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betacoreoverviewtransitions" href="/beta/core/overview/transitions/">Transitions</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betacoreoverviewtranslations" href="/beta/core/overview/translations/">Translations</a>
      
      
    </li>

  </ul>


</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">

  <li class="td-sidebar-nav__section-title">
    <a  href="/beta/core/process/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Process</a>
  </li>
  <ul>

    <li class="collapse " id="betacoreprocess">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betacoreprocessworkflow" href="/beta/core/process/workflow/">Workflow</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betacoreprocessreleasing" href="/beta/core/process/releasing/">Releasing</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betacoreprocessupdate-dependencies" href="/beta/core/process/update-dependencies/">Dependencies</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betacoreprocessstyle-guide" href="/beta/core/process/style-guide/">Style Guide for Code</a>
      
      
    </li>

  </ul>


</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">

  <li class="td-sidebar-nav__section-title">
    <a  href="/beta/core/guides/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Guides</a>
  </li>
  <ul>

    <li class="collapse " id="betacoreguides">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betacoreguidesfixing-e2e-tests" href="/beta/core/guides/fixing-e2e-tests/">E2E Tests</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betacoreguidesusing-git" href="/beta/core/guides/using-git/">Using Git</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betacoreguidesusing-npm" href="/beta/core/guides/using-npm/">Using NPM</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betacoreguidesusers-bulk-load" href="/beta/core/guides/users-bulk-load/">Bulk Load Users</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betacoreguidesusing-windows" href="/beta/core/guides/using-windows/">Windows Development</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betacoreguidesdocker-setup" href="/beta/core/guides/docker-setup/">Docker Setup</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betacoreguidesget-android-logs" href="/beta/core/guides/get-android-logs/">Get Android Logs</a>
      
      
    </li>

  </ul>


</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">

  <li class="td-sidebar-nav__section-title">
    <a  href="/beta/core/faq/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">FAQ</a>
  </li>
  <ul>

    <li class="collapse " id="betacorefaq">
      
      
      
    </li>

  </ul>


</ul>

      
      
    </li>

  </ul>


</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">

  <li class="td-sidebar-nav__section-title">
    <a  href="/beta/design/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Design System</a>
  </li>
  <ul>

    <li class="collapse " id="betadesign">
      
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">

  <li class="td-sidebar-nav__section-title">
    <a  href="/beta/design/personas/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Personas</a>
  </li>
  <ul>

    <li class="collapse " id="betadesignpersonas">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betadesignpersonaschw-janet" href="/beta/design/personas/chw-janet/">CHW</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betadesignpersonaschw-supervisor-ann" href="/beta/design/personas/chw-supervisor-ann/">CHW Supervisor</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betadesignpersonasregional-manager-christina" href="/beta/design/personas/regional-manager-christina/">Regional Manager</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betadesignpersonasnurse-mary" href="/beta/design/personas/nurse-mary/">Nurse</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betadesignpersonasdata-manager-paul" href="/beta/design/personas/data-manager-paul/">Data Manager</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betadesignpersonasapp-builder" href="/beta/design/personas/app-builder/">App Builders</a>
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">

  <li class="td-sidebar-nav__section-title">
    <a  href="/beta/design/personas/partners/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Partners</a>
  </li>
  <ul>

    <li class="collapse " id="betadesignpersonaspartners">
      
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betadesignpersonaspartnersimplementers" href="/beta/design/personas/partners/implementers/">Implementers</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betadesignpersonaspartnerslocal-governments" href="/beta/design/personas/partners/local-governments/">Local Gov</a>
      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betadesignpersonaspartnersnational-governments" href="/beta/design/personas/partners/national-governments/">National Gov</a>
      
      
    </li>

  </ul>


</ul>

      
      
    </li>

  </ul>


</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">

  <li class="td-sidebar-nav__section-title">
    <a  href="/beta/design/apps/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">App Development</a>
  </li>
  <ul>

    <li class="collapse " id="betadesignapps">
      
      
      
    </li>

  </ul>


</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">

  <li class="td-sidebar-nav__section-title">
    <a  href="/beta/design/core/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Core Development</a>
  </li>
  <ul>

    <li class="collapse " id="betadesigncore">
      
      
      
    </li>

  </ul>


</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">

  <li class="td-sidebar-nav__section-title">
    <a  href="/beta/design/icons/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Icon Library</a>
  </li>
  <ul>

    <li class="collapse " id="betadesignicons">
      
      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">

  <li class="td-sidebar-nav__section-title">
    <a  href="/beta/design/icons/forms_tasks_targets/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">Forms, Tasks, Targets</a>
  </li>
  <ul>

    <li class="collapse " id="betadesigniconsforms_tasks_targets">
      
      
      
    </li>

  </ul>


</ul>

      
      
      
      






<ul class="td-sidebar-nav__section pr-md-3">

  <li class="td-sidebar-nav__section-title">
    <a  href="/beta/design/icons/people_and_places/" class="align-left pl-0 pr-2 collapsed td-sidebar-link td-sidebar-link__section">People and Places</a>
  </li>
  <ul>

    <li class="collapse " id="betadesigniconspeople_and_places">
      
      
      
    </li>

  </ul>


</ul>

      
      
    </li>

  </ul>


</ul>

      
      
    </li>

  </ul>


</ul>

      
      
      
      
      
      <a class="td-sidebar-link td-sidebar-link__page " id="m-betadocs-style-guide" href="/beta/docs-style-guide/">Style Guide for Docs</a>
      
      
    </li>


</ul>

    
    
  </nav>
</div>




          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
            






<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">





<a href="https://github.com/medic/cht-docs/edit/master/content/en/apps/guides/database-conflicts.md" target="_blank"><i class="fa fa-edit fa-fw"></i> Edit this page</a>
<a href="https://github.com/medic/cht-docs/issues/new?title=Database%20Conflicts" target="_blank"><i class="fab fa-github fa-fw"></i> Create documentation issue</a>


<a href="https://github.com/medic/cht-core/issues/new" target="_blank"><i class="fas fa-tasks fa-fw"></i> Create project issue</a>

</div>






<nav id="TableOfContents">
  <ul>
    <li><a href="#an-example">An example</a></li>
    <li><a href="#how-to-manage-conflicts">How to manage conflicts</a>
      <ul>
        <li><a href="#identify-why-conflicts-are-occuring">Identify why conflicts are occuring</a></li>
        <li><a href="#if-appropriate-raise-a-bug">If appropriate, raise a bug</a></li>
        <li><a href="#regardless-resolve-the-conflicts">Regardless, resolve the conflicts</a></li>
      </ul>
    </li>
  </ul>
</nav>



          </div>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            
  

            <nav aria-label="breadcrumb" class="d-none d-md-block d-print-none">
	<ol class="breadcrumb spb-1">
		










<li class="breadcrumb-item" >
	<a href="https://docs.communityhealthtoolkit.org/beta/apps/">CHT Applications</a>
</li>




<li class="breadcrumb-item" >
	<a href="https://docs.communityhealthtoolkit.org/beta/apps/guides/">Quick Guides</a>
</li>




<li class="breadcrumb-item active" aria-current="page">
	<a href="https://docs.communityhealthtoolkit.org/beta/apps/guides/database-conflicts/">Database Conflicts</a>
</li>

	</ol>
</nav	>

            

<div class="td-content">
	<h1>Database Conflicts</h1>
    <div class="lead">How to handle conflicts with CouchDB documents</div>
	       
	<p>Conflicts are a natural and unavoidable part of working in a distributed system.</p>
<p>Conflicts occur when one client (eg PouchDB) attempts to replicate to another (eg CouchDB), and the document that the first has does not have the same tree of changes that the second one has.</p>
<h2 id="an-example">An example</h2>
<p>To make it clear what&rsquo;s happening, let&rsquo;s walk through an example. If you already understand conflicts feel free to skip this section.</p>
<p>Let&rsquo;s say you register a pregnancy in the UI. And then you notice that you got the LMP wrong, so you hit edit and quickly make the change.</p>
<p>Meanwhile, sentinel notices that you registers a pregnancy, and before you have a chance to change the LMP, sets up a bunch of recurring messages, editing the document.</p>
<p>Sentinel has now made a change to the first version of your document, and you&rsquo;re trying to also make a change to the first version. These conflict.</p>
<h2 id="how-to-manage-conflicts">How to manage conflicts</h2>
<p>Conflicts will appear on the #downtime Slack channel, along with the other alerts. If a server you manage has a conflict, you should do the following:</p>
<h3 id="identify-why-conflicts-are-occuring">Identify why conflicts are occuring</h3>
<p>Take a look at the conflicts view, at <code>https://yourserver/medic/_design/medic-conflicts/_view/conflicts</code>. Each entry in that view looks like this:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">&#34;id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;1B7922A6-A6D6-C956-BBAE-DE5EB5A2E6C8&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">&#34;key&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
        <span style="color:#4e9a06">&#34;1-82d9a42305a79e403d9eca6a9a9daae9&#34;</span>
    <span style="color:#000;font-weight:bold">],</span>
    <span style="color:#204a87;font-weight:bold">&#34;value&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span>
<span style="color:#000;font-weight:bold">}</span><span style="color:#a40000">,</span>
</code></pre></div><p>The <code>id</code> is the <code>_id</code> of the conflicting document, and the <code>key</code> is a list of conflicting <code>_rev</code>s.</p>
<p>For each conflicting document, download that document, as well as all the <code>_rev</code>s indicated in the <code>key</code> above. To download a document with a specific <code>_rev</code>, pass the <code>rev</code> parameter.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">curl <span style="color:#4e9a06">&#39;https://yourserver/medic/1B7922A6-A6D6-C956-BBAE-DE5EB5A2E6C8&#39;</span> &gt; doc.json
curl <span style="color:#4e9a06">&#39;https://yourserver/medic/1B7922A6-A6D6-C956-BBAE-DE5EB5A2E6C8?rev=1-82d9a42305a79e403d9eca6a9a9daae9&#39;</span> &gt; doc-conflict1.json
</code></pre></div><p>Now you have all versions of the document, you can diff them and try to determine what went wrong.</p>
<p>A common problem, for example, might be sentinel hitting a document really quickly between you creating it and editing it.</p>
<p>A less common problem that requires some special attention, is UUID collisions (see below).</p>
<p>If you get stuck feel free to escalate to a developer, who can take a look.</p>
<h3 id="if-appropriate-raise-a-bug">If appropriate, raise a bug</h3>
<p>If you determine (or just suspect) that the problem could be in our code or data structures, feel free to raise a bug to development. For example, historically read status has been stored against the document, which can easily cause conflicts if you create a document and then instantly view it with sentinel processing in the background.</p>
<p>While some conflicts are inevitable, we want to architect away from them as much as possible. Ideally tech leads would never have to resolve conflicts.</p>
<h3 id="regardless-resolve-the-conflicts">Regardless, resolve the conflicts</h3>
<p>Now that you&rsquo;ve diagnosed the problem, and perhaps reported a bug, you should resolve the conflict.</p>
<p>This is <strong>extremely</strong> important. Conflicts cause saved changes to not appear against documents silently, and could cause important document changes (eg fixing someone&rsquo;s EDD) to not occur.</p>
<p>For a document to no longer be conflicted, there must only be one active <code>_rev</code>. You would do this by picking one rev and updating it with the changes you want to make, and then updating the others with the <code>_deleted: true</code> property.</p>
<p>You can tell that a document is no longer conflicted if they don&rsquo;t appear in the view, or if when you request the document with <code>?conflicts=true</code> the <code>_conflicts</code> property either doesn&rsquo;t appear or is empty:</p>
<pre><code>https://yourserver/medic/yourdocid?conflicts=true

{
  &quot;_id&quot;: &quot;yourdocid&quot;,
  &quot;_rev&quot;: &quot;2-the-current-rev&quot;
  &quot;_conflicts&quot;: [
    &quot;2-a-conflicting-rev&quot;
  ]
}
</code></pre><p>In the above example, <code>yourdocid</code> has two revisions that conflict with each other. Here you would need to update one of the revs (it doesn&rsquo;t matter which) with the other&rsquo;s changes, then delete the other rev. You would then see:</p>
<pre><code>https://yourserver/medic/yourdocid?conflicts=true

{
  &quot;_id&quot;: &quot;yourdocid&quot;,
  &quot;_rev&quot;: &quot;3-the-new-rev&quot;
}
</code></pre><h4 id="a-trivial-example">A trivial example</h4>
<p>Let&rsquo;s say that you have two documents, and the diff between them looks something like this:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff"><span style="color:#000080;font-weight:bold">===================================================================
</span><span style="color:#000080;font-weight:bold"></span><span style="color:#a40000">--- 277533E3-A41B-3C46-909F-BCA038197C1E___2-2fff60be1557fdfef9915aa09e1b5119.json
</span><span style="color:#a40000"></span><span style="color:#00a000">+++ 277533E3-A41B-3C46-909F-BCA038197C1E___2-d2a7186380b72306d75cd64b64402575.json
</span><span style="color:#00a000"></span><span style="color:#800080;font-weight:bold">@@ -1,7 +1,7 @@
</span><span style="color:#800080;font-weight:bold"></span> {
   &#34;_id&#34;: &#34;277533E3-A41B-3C46-909F-BCA038197C1E&#34;,
<span style="color:#a40000">-  &#34;_rev&#34;: &#34;2-2fff60be1557fdfef9915aa09e1b5119&#34;,
</span><span style="color:#a40000"></span><span style="color:#00a000">+  &#34;_rev&#34;: &#34;2-d2a7186380b72306d75cd64b64402575&#34;,
</span><span style="color:#00a000"></span>   &#34;data&#34;: &#34;some shared data&#34;,
   &#34;read&#34;: [
<span style="color:#a40000">-    &#34;some_user&#34;
</span><span style="color:#a40000"></span><span style="color:#00a000">+    &#34;admin&#34;
</span><span style="color:#00a000"></span>   ]
 }
</code></pre></div><p>The problem here is clear: <code>some_user</code> and <code>admin</code> read the document at the same time. To solve this, we could add <code>some_user</code> to the revision with <code>admin</code> already in it, and then delete the <code>some_user</code> revision:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"> <span style="color:#000;font-weight:bold">{</span>
   <span style="color:#204a87;font-weight:bold">&#34;_id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;277533E3-A41B-3C46-909F-BCA038197C1E&#34;</span><span style="color:#000;font-weight:bold">,</span>
   <span style="color:#204a87;font-weight:bold">&#34;_rev&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;2-d2a7186380b72306d75cd64b64402575&#34;</span><span style="color:#000;font-weight:bold">,</span>
   <span style="color:#204a87;font-weight:bold">&#34;data&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;some shared data&#34;</span><span style="color:#000;font-weight:bold">,</span>
   <span style="color:#204a87;font-weight:bold">&#34;read&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
     <span style="color:#4e9a06">&#34;admin&#34;</span><span style="color:#000;font-weight:bold">,</span>
     <span style="color:#4e9a06">&#34;some_user&#34;</span>
   <span style="color:#000;font-weight:bold">]</span>
 <span style="color:#000;font-weight:bold">}</span>
</code></pre></div><div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"> <span style="color:#000;font-weight:bold">{</span>
   <span style="color:#204a87;font-weight:bold">&#34;_id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;277533E3-A41B-3C46-909F-BCA038197C1E&#34;</span><span style="color:#000;font-weight:bold">,</span>
   <span style="color:#204a87;font-weight:bold">&#34;_rev&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;2-2fff60be1557fdfef9915aa09e1b5119&#34;</span><span style="color:#000;font-weight:bold">,</span>
   <span style="color:#204a87;font-weight:bold">&#34;_deleted&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
   <span style="color:#204a87;font-weight:bold">&#34;data&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;some shared data&#34;</span><span style="color:#000;font-weight:bold">,</span>
   <span style="color:#204a87;font-weight:bold">&#34;read&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
     <span style="color:#4e9a06">&#34;some_user&#34;</span>
   <span style="color:#000;font-weight:bold">]</span>
 <span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h4 id="resolving-uuid-collisions">Resolving UUID collisions</h4>
<p>A UUID collision is a rare event where two clients (eg two android phones running our application) generate the same UUID ID for two completely different documents.</p>
<p>You can tell when your conflict is a UUID collision as there is no common root between the two conflicting versions. For example, one might be of type person and one might of type data_record.</p>
<p>These situations are more complicated, and require that you essentially recreate all conflicting versions as new documents, and fix any linkages that exist in the database.</p>
<p>Let&rsquo;s say you find the following situation:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff">{
  &#34;_id&#34;: &#34;7FADDF76-55E4-4E50-9444-5E468E61EA83&#34;
<span style="color:#a40000">- &#34;_rev&#34;: &#34;1-e4da228c29dc4ebc8b156967bbf48bd1&#34;,
</span><span style="color:#a40000"></span><span style="color:#00a000">+ &#34;_rev&#34;: &#34;1-ce40d1dc470643e2b9be9368ea9ff240&#34;,
</span><span style="color:#00a000"></span><span style="color:#a40000">- &#34;type&#34;: &#34;person&#34;
</span><span style="color:#a40000"></span><span style="color:#00a000">+ &#34;type&#34;: &#34;data_record&#34;
</span><span style="color:#00a000"></span>&lt;snip a bunch more stuff that doesn&#39;t relate to each other&gt;
}
</code></pre></div><p>You will want to do four things:</p>
<ul>
<li>Download the <code>_rev</code> for the <code>person</code> and create a new document, with a new uuid, for that document (you can do this by uploadig the document without an <code>_id</code> or <code>_rev</code> parameter and let CouchDB generate them for you)</li>
<li>Do the same for the <code>data_record</code> version</li>
<li>Delete the main conflicting document <code>7FADDF76-55E4-4E50-9444-5E468E61EA83</code></li>
</ul>
<p>And finally, find any references to <code>7FADDF76-55E4-4E50-9444-5E468E61EA83</code>, work out which doc they were <em>supposed</em> to point to, and then edit those UUIDs to be the correct UUID <code>_id</code> from the docs you created above.</p>
<p>Because this should be a rare event and a generic view would be enormous, we do not ship a view that helps you find this out.</p>
<p>However, you can create your own view! You&rsquo;re going to want to create a DDOC specifically for this view. You can follow the following template to create what you want:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">&#34;_id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;_design/docs-by-reference&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#204a87;font-weight:bold">&#34;views&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">&#34;docs-by-reference&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">&#34;map&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;function(doc) {\n  var KEYS = [];\n\n  // TODO: consider switching this around to whitelist doc types\n  if (doc._id.match(/-info$/) ||\n      doc._id.match(/^_local/)) {\n    return;\n  }\n\n  var goDeeper = function(obj, path) {\n    Object.keys(obj).forEach(function(key) {\n      if (typeof obj[key] === &#39;string&#39; &amp;&amp;\n          KEYS.indexOf(obj[key]) !== -1) {\n        emit(obj[key], path + &#39;.&#39; + key);\n      }\n\n      if (obj[key] &amp;&amp; typeof obj[key] === &#39;object&#39;) {\n        goDeeper(obj[key], path + &#39;.&#39; + key);\n      }\n    });\n  };\n\n  goDeeper(doc, doc._id);\n}&#34;</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>In this, add any IDs you want to be found in the <code>KEYS</code> variable at the top of the function. So in our case, we would change <code>KEYS</code> to look like this:</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">KEYS</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#39;7FADDF76-55E4-4E50-9444-5E468E61EA83&#39;</span><span style="color:#000;font-weight:bold">]</span>
</code></pre></div><p>Upload this document to CouchDB (do not just add the view to an existing DDOC, as you will force all views on that DDOC to regenerate) and then warm up the views by querying it once (it may take a long time to run).</p>
<p>Once it is complete you can query the view again to return a list of documents that reference the ids you hard-coded above.</p>
<p>This will help you to identify which documents are affected by this change. Usually the only change needed is to change the ID located to the new ones you generated.</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">&#34;total_rows&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#204a87;font-weight:bold">&#34;offset&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#204a87;font-weight:bold">&#34;rows&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
    <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">&#34;id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;1B7922A6-A6D6-C956-BBAE-DE5EB5A2E6C8&#34;</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#204a87;font-weight:bold">&#34;key&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
        <span style="color:#4e9a06">&#34;7FADDF76-55E4-4E50-9444-5E468E61EA83&#34;</span>
      <span style="color:#000;font-weight:bold">],</span>
      <span style="color:#204a87;font-weight:bold">&#34;value&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;1B7922A6-A6D6-C956-BBAE-DE5EB5A2E6C8.fields.inputs.contact._id&#34;</span>
    <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">&#34;id&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;1B7922A6-A6D6-C956-BBAE-DE5EB5A2E6C8&#34;</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#204a87;font-weight:bold">&#34;key&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
        <span style="color:#4e9a06">&#34;7FADDF76-55E4-4E50-9444-5E468E61EA83&#34;</span>
      <span style="color:#000;font-weight:bold">],</span>
      <span style="color:#204a87;font-weight:bold">&#34;value&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;1B7922A6-A6D6-C956-BBAE-DE5EB5A2E6C8.fields.patient_id&#34;</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">]</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>In this example, there are two references to <code>7FADDF76-55E4-4E50-9444-5E468E61EA83</code>, both in the <code>1B7922A6-A6D6-C956-BBAE-DE5EB5A2E6C8</code> document, one at <code>fields.inputs.contact._id</code> and one at <code>fields.patient_id</code>.</p>
<p>If you get stuck, feel free to contact a developer (either a specific one, or just post in <code>#development</code>) and they can help you out.</p>

	


	
		<style>
  .feedback--answer {
    display: inline-block;
  }
  .feedback--answer-no {
    margin-left: 1em;
  }
  .feedback--response {
    display: none;
    margin-top: 1em;
  }
  .feedback--response__visible {
    display: block;
  }
</style>
<h2 class="feedback--title">Feedback</h2>
<p class="feedback--question">Was this page helpful?</p>
<button class="feedback--answer feedback--answer-yes">Yes</button>
<button class="feedback--answer feedback--answer-no">No</button>
<p class="feedback--response feedback--response-yes">
  Glad to hear it! Please <a href="https://github.com/medic/cht-docs/issues/new">tell us how we can improve</a>.
</p>
<p class="feedback--response feedback--response-no">
  Sorry to hear that. Please <a href="https://github.com/medic/cht-docs/issues/new">tell us how we can improve</a>.
</p>
<script>
  const yesButton = document.querySelector('.feedback--answer-yes');
  const noButton = document.querySelector('.feedback--answer-no');
  const yesResponse = document.querySelector('.feedback--response-yes');
  const noResponse = document.querySelector('.feedback--response-no');
  const disableButtons = () => {
    yesButton.disabled = true;
    noButton.disabled = true;
  };
  const sendFeedback = (value) => {
    if (typeof ga !== 'function') return;
    const args = {
      command: 'send',
      hitType: 'event',
      category: 'Helpful',
      action: 'click',
      label: window.location.pathname,
      value: value
    };
    ga(args.command, args.hitType, args.category, args.action, args.label, args.value);
  };
  yesButton.addEventListener('click', () => {
    yesResponse.classList.add('feedback--response__visible');
    disableButtons();
    sendFeedback(1);
  });
  noButton.addEventListener('click', () => {
    noResponse.classList.add('feedback--response__visible');
    disableButtons();
    sendFeedback(0);
  });
</script>

		<br />
	
	
	<div class="text-muted mt-5 pt-3 border-top">Last modified 04.06.2020: <a  href="https://github.com/medic/cht-docs/commit/d977422c668f3f62f20736d76a0ac71102025e59">Update Alert Message (d977422)</a>
</div>
</div>


          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2020 CHT All Rights Reserved</small>
        <small class="ml-1"><a href="https://docs.google.com/document/d/1MaI1rgYMNyCZF2eEjBuvnBDoCYHDKlx4k_N5pkDiWu8/edit?usp=sharing" target="_blank">Privacy Policy</a></small>
	
      </div>
    </div>
  </div>
</footer>


    </div>
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>









<script src="/beta/js/main.min.7afee248b9b3c1d4438c6841cc272ae0ac1f81a3ee5c0ed939f1d57c18de3f7d.js" integrity="sha256-ev7iSLmzwdRDjGhBzCcq4KwfgaPuXA7ZOfHVfBjeP30=" crossorigin="anonymous"></script>



  </body>
</html>