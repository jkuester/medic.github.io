<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Community Health Toolkit â€“ Tracking and Improving Performance</title><link>https://docs.communityhealthtoolkit.org/beta/apps/guides/performance/</link><description>Recent content in Tracking and Improving Performance on Community Health Toolkit</description><generator>Hugo -- gohugo.io</generator><atom:link href="https://docs.communityhealthtoolkit.org/beta/apps/guides/performance/index.xml" rel="self" type="application/rss+xml"/><item><title>Apps: Purging</title><link>https://docs.communityhealthtoolkit.org/beta/apps/guides/performance/purging/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://docs.communityhealthtoolkit.org/beta/apps/guides/performance/purging/</guid><description>
&lt;p>&lt;em>Only available in 3.7.0 and above&lt;/em>&lt;/p>
&lt;p>Purging is a tool that allows you to increase performance and available disk space for offline users (eg CHWs) by removing unneeded documents from their device.&lt;/p>
&lt;p>As users continually generate new reports their performance may naturally degrade as a result.
You can use purging to remove older documents that are no longer relevant from their devices.
Purging only removes documents from user&amp;rsquo;s devices: these reports are still available for
online analytics and impact metrics.&lt;/p>
&lt;p>Purging is disabled by default, and is enabled if a purge function is specified in
&lt;code>app_settings.json&lt;/code>, along with a run schedule.&lt;/p>
&lt;p>The following example would purge all reports that were created more than a year ago:&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-json" data-lang="json">&lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;#34;//&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;other app_settings settings&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;#34;purge&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;#34;fn&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;function(userCtx, contact, reports, messages) { const old = Date.now() - (1000 * 60 * 60 * 24 * 365); return reports.filter(r =&amp;gt; r.reported_date &amp;lt; old).map(r =&amp;gt; r._id);}&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;#34;text_expression&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;at 12 am on Sunday&amp;#34;&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>Purging is both very powerful and also very dangerous&lt;/strong>. Read the rest of this document carefully to make sure you completely understand how to purge and the ramifications of doing so, before using purging in your project.&lt;/p>
&lt;h2 id="server-side">Server-side&lt;/h2>
&lt;p>Purging runs on the server on a configurable schedule.&lt;/p>
&lt;p>It will iterate over all users to generate a list of unique roles groups that represent every user.
Each group will have their purged docs saved in an individual database.&lt;/p>
&lt;p>Then, it will iterate over all existent contacts, collecting all reports about that contact along
with all sms messages that the contact has sent or received.
This is similar to the scoping you may have encountered when configuring &lt;a href="https://docs.communityhealthtoolkit.org/beta/apps/reference/tasks/">tasks&lt;/a> and &lt;a href="https://docs.communityhealthtoolkit.org/beta/apps/reference/targets/">targets&lt;/a>.&lt;/p>
&lt;p>The configured purge function runs over all combinations of purge scope (contact + reports + messages)
and user context (unique list of roles) to determine which docs should be purged.&lt;/p>
&lt;p>The resulting list of docs to be purged is compared to the existent purged docs so that only the differences
are saved (old purges are reverted and new purges are added).&lt;/p>
&lt;p>A document is considered purged for a user if a document with the same id, prefixed by &lt;code>purge&lt;/code>,
exists in the corresponding purge database.
The following user:&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-json" data-lang="json">&lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;#34;name&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;org.couchdb.user:&amp;lt;your user&amp;gt;&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;#34;roles&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span> &lt;span style="color:#000;font-weight:bold">[&lt;/span>
&lt;span style="color:#4e9a06">&amp;#34;district_admin&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span>
&lt;span style="color:#4e9a06">&amp;#34;supervisor&amp;#34;&lt;/span>
&lt;span style="color:#000;font-weight:bold">]&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;p>would get their purges from a &lt;code>medic-purged-role-&amp;lt;role_hash&amp;gt;&lt;/code> where &lt;code>role_hash&lt;/code> is an md5 hash of the
user&amp;rsquo;s roles.&lt;/p>
&lt;p>When users sync (includes initial sync), they will only download documents that are not purged for their roles.&lt;/p>
&lt;h2 id="client-side">Client-side&lt;/h2>
&lt;p>Purging runs on the user&amp;rsquo;s device at startup, before the application booting, when any of these
conditions are met:&lt;/p>
&lt;ul>
&lt;li>The device was just setup and so initial sync just occurred.&lt;/li>
&lt;li>The user&amp;rsquo;s roles list has changed&lt;/li>
&lt;li>It has been more than 7 days since the user has purged.&lt;/li>
&lt;/ul>
&lt;p>Purging will not run on startup if purge is not configured, if last purge occurred recently or if
the user doesn&amp;rsquo;t have an internet connection.&lt;/p>
&lt;p>When purging runs, the device calls an API endpoint that returns batches of doc ids that have
been purged since last time the same device has run purge.
The system is similar to CouchDB replication, in the sense that a &lt;code>checkpointer&lt;/code> document
is saved in the corresponding server-side database, that stores the &lt;code>last_seq&lt;/code> that the device has
downloaded and is used to get the next batch of ids.
After receiving a batch of ids, the device simply deletes the indicated docs locally,
marking them with a &lt;code>purged&lt;/code> flag.&lt;/p>
&lt;h2 id="configuration">Configuration&lt;/h2>
&lt;p>To enable purging, write your purge configuration to &lt;code>purge.js&lt;/code> in your project root:&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-js" data-lang="js">&lt;span style="color:#000">module&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">exports&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#000">text_expression&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">&amp;#39;at 9 am on Sunday&amp;#39;&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span>
&lt;span style="color:#000">run_every_days&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">7&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span>
&lt;span style="color:#000">cron&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">&amp;#39;0 1 * * SUN&amp;#39;&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span>
&lt;span style="color:#000">fn&lt;/span>&lt;span style="color:#ce5c00;font-weight:bold">:&lt;/span> &lt;span style="color:#204a87;font-weight:bold">function&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">userCtx&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">contact&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">reports&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000">messages&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">const&lt;/span> &lt;span style="color:#000">old&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#204a87">Date&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">now&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">-&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1000&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">60&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">60&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">24&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">365&lt;/span>&lt;span style="color:#000;font-weight:bold">);&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">const&lt;/span> &lt;span style="color:#000">oldMessages&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#204a87">Date&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">now&lt;/span>&lt;span style="color:#000;font-weight:bold">()&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">-&lt;/span> &lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#0000cf;font-weight:bold">1000&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">60&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">60&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">24&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">*&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">90&lt;/span>&lt;span style="color:#000;font-weight:bold">);&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">const&lt;/span> &lt;span style="color:#000">reportsToPurge&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#000">reports&lt;/span>
&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">filter&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">r&lt;/span> &lt;span style="color:#000;font-weight:bold">=&amp;gt;&lt;/span> &lt;span style="color:#000">r&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">reported_date&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&lt;/span> &lt;span style="color:#000">old&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">map&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">r&lt;/span> &lt;span style="color:#000;font-weight:bold">=&amp;gt;&lt;/span> &lt;span style="color:#000">r&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">_id&lt;/span>&lt;span style="color:#000;font-weight:bold">);&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">const&lt;/span> &lt;span style="color:#000">messagesToPurge&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">=&lt;/span> &lt;span style="color:#000">messages&lt;/span>
&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">filter&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">m&lt;/span> &lt;span style="color:#000;font-weight:bold">=&amp;gt;&lt;/span> &lt;span style="color:#000">m&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">reported_date&lt;/span> &lt;span style="color:#ce5c00;font-weight:bold">&amp;lt;&lt;/span> &lt;span style="color:#000">oldMessages&lt;/span>&lt;span style="color:#000;font-weight:bold">)&lt;/span>
&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">map&lt;/span>&lt;span style="color:#000;font-weight:bold">(&lt;/span>&lt;span style="color:#000">m&lt;/span> &lt;span style="color:#000;font-weight:bold">=&amp;gt;&lt;/span> &lt;span style="color:#000">m&lt;/span>&lt;span style="color:#000;font-weight:bold">.&lt;/span>&lt;span style="color:#000">_id&lt;/span>&lt;span style="color:#000;font-weight:bold">);&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">return&lt;/span> &lt;span style="color:#000;font-weight:bold">[...&lt;/span>&lt;span style="color:#000">reportsToPurge&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#000;font-weight:bold">...&lt;/span>&lt;span style="color:#000">messagesToPurge&lt;/span>&lt;span style="color:#000;font-weight:bold">];&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#000;font-weight:bold">};&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="purge-configuration">Purge configuration&lt;/h3>
&lt;p>As shown above, you should be exporting a property &lt;code>fn&lt;/code> defining a self contained function:
it should have no outside dependencies - like used variables, required modules or call outside functions.&lt;/p>
&lt;p>This function takes four parameters:&lt;/p>
&lt;ul>
&lt;li>&lt;code>userCtx&lt;/code>, an object with the user&amp;rsquo;s &lt;code>roles&lt;/code> as fields. For more information read the &lt;a href="https://docs.couchdb.org/en/stable/json-structure.html#userctx-object">documentation for the User Context Object&lt;/a>.&lt;/li>
&lt;li>&lt;code>contact&lt;/code>, the contact document of a patient or other contact who has reports about them.&lt;/li>
&lt;li>&lt;code>reports&lt;/code>, an array of all reports for that patient that are present on the server.&lt;/li>
&lt;li>&lt;code>messages&lt;/code>, an array of sms messages that the contact has sent or received&lt;/li>
&lt;/ul>
&lt;p>And should return an array of &lt;code>_id&lt;/code> values for docs you would like to be purged
(or &lt;code>undefined&lt;/code> / nothing if you don&amp;rsquo;t wish to purge anything).
Only ids of docs that were passed to the function are valid for purging: you are not allowed to purge other documents.&lt;/p>
&lt;p>In the cases of reports that do not have patients or their patients are not found, the &lt;code>purge&lt;/code> function
will receive an empty object as &lt;code>contact&lt;/code>.
In the cases of reports about deleted patients, the &lt;code>purge&lt;/code> function will receive a &lt;code>{ _deleted: true }&lt;/code>
object as the &lt;code>contact&lt;/code>.&lt;/p>
&lt;h3 id="schedule-configuration">Schedule configuration&lt;/h3>
&lt;p>You must set a schedule for purging to run server-side.
Depending on the size of the database and server capacity, purging could be a lengthy and
resource intensive operation, so it is recommended you run purge on a schedule that your server
can sustain (for example at nighttime in the weekends).&lt;/p>
&lt;p>You can also change the frequency of local purge downloads (default being every 7 days).&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>property&lt;/th>
&lt;th>description&lt;/th>
&lt;th>required&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;code>fn&lt;/code>&lt;/td>
&lt;td>Self-contained purge function&lt;/td>
&lt;td>yes&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>run_every_days&lt;/code>&lt;/td>
&lt;td>The interval (in days) at which purges will be downloaded client-side. &lt;em>Default 7&lt;/em>.&lt;/td>
&lt;td>no&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>text_expression&lt;/code>&lt;/td>
&lt;td>Any valid text expression to describe the interval of running purge server-side. For more information, see &lt;a href="https://bunkat.github.io/later/parsers.html#text">LaterJS&lt;/a>&lt;/td>
&lt;td>no if &lt;code>cron&lt;/code> provided&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>cron&lt;/code>&lt;/td>
&lt;td>Any valid Cron expression to describe the interval of running purge server-side. For more information, see &lt;a href="https://bunkat.github.io/later/parsers.html#cron">LaterJS&lt;/a>&lt;/td>
&lt;td>no if &lt;code>text_expression&lt;/code> provided&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>Example of purge configured in your app_settings:&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-json" data-lang="json"> &lt;span style="color:#4e9a06">&amp;#34;//&amp;#34;&lt;/span>&lt;span style="color:#a40000">:&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;other app_settings settings&amp;#34;&lt;/span>&lt;span style="color:#a40000">,&lt;/span>
&lt;span style="color:#4e9a06">&amp;#34;purge&amp;#34;&lt;/span>&lt;span style="color:#a40000">:&lt;/span> &lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;#34;fn&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;function(userCtx, contact, reports, messages) { return []; }&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;#34;cron&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;0 1 * * SUN&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;#34;text_expression&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;at 1:00 am on Sun&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;#34;run_every_days&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">5&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="considerations">Considerations&lt;/h2>
&lt;h3 id="purged-documents-server-side">Purged documents server-side&lt;/h3>
&lt;p>Purging is run as a scheduled task in Sentinel.&lt;/p>
&lt;p>Purging does not touch documents in the &lt;code>medic&lt;/code> database, everything is done in separate purge databases
(&lt;code>medic-purged-roles-&amp;lt;roles-hash&amp;gt;&lt;/code>).&lt;/p>
&lt;p>The purge databases names contain an md5 of the JSON representation of a list of unique roles.
They also contain a &lt;code>_local/info&lt;/code> doc where the roles are listed in clear text.&lt;/p>
&lt;p>A &lt;code>purgelog&lt;/code> document is saved in &lt;code>medic-sentinel&lt;/code> after every purge. The purgelog has a meaningful
ID: &lt;code>purgelog:&amp;lt;timestamp&amp;gt;&lt;/code>, where timestamp represents the moment when purge was completed. The doc
also contains a property &lt;code>roles&lt;/code> with the collection of roles purge has run for, and a &lt;code>duration&lt;/code> property
representing the time it took to run purge, in ms.
You can retrieve a list of all your purge logs, descending from newest to oldest, with this request:&lt;/p>
&lt;p>&lt;code>https(s)://&amp;lt;host&amp;gt;/medic-sentinel/_all_docs?end_key=&amp;quot;purgelog:&amp;quot;&amp;amp;start_key=&amp;quot;purgelog:\ufff0&amp;quot;&amp;amp;descending=true&lt;/code>&lt;/p>
&lt;p>Purging is reversible. If you update your purge function, when running purge the old invalid
purges will be deleted. This does not mean that devices will automatically re-download documents that
become unpurged. In order for the user to re-download a previously purged document, the document either
needs to be updated in the &lt;code>medic&lt;/code> database on the server or the user has to download all data again.&lt;/p>
&lt;p>Running purge will not remove old purge databases, even if they don&amp;rsquo;t correspond to any existent users.
Their removal is a manual process.&lt;/p>
&lt;p>Purge does not run when adding new roles or adding said new roles to users. It also does not run when an existent
user is updated to have a new unique list of roles (one that purge has not run over yet).
This means that roles need to be planned carefully in order to take advantage of serverside purge. If purge
has not run for the user&amp;rsquo;s list of roles at the moment of initial replication, the user will download &lt;strong>all&lt;/strong>
documents - only to be purged later.&lt;/p>
&lt;h3 id="purged-documents-client-side">Purged documents client-side&lt;/h3>
&lt;p>The key thing to keep in mind while purging is that &lt;strong>documents that you purge are deleted on
user&amp;rsquo;s device&lt;/strong>. This sounds obvious, but it&amp;rsquo;s important to understand &lt;em>how&lt;/em> this affects
the running of the application:&lt;/p>
&lt;ul>
&lt;li>Any &lt;strong>rules&lt;/strong> you have written that presume that the document exists may break.
For example, if the document completes a task, purging it will reopen that task,
unless you &lt;em>also&lt;/em> purge the document that created the task in the first place
(while making sure that purging &lt;em>that&lt;/em> report doesn&amp;rsquo;t break more things!)&lt;/li>
&lt;li>Similarly &lt;strong>targets&lt;/strong> won&amp;rsquo;t be able to use the report to generate values, so counts may go
down or become inaccurate&lt;/li>
&lt;li>Additionally, the &lt;strong>contact summary&lt;/strong> will also lose out on being able to use that report&lt;/li>
&lt;li>Changing the user&amp;rsquo;s roles list (adding/removing roles) will cause the user to download &lt;strong>all purged docs ids&lt;/strong>
from the purge database corresponding to their new roles list.&lt;/li>
&lt;/ul>
&lt;p>More subtly, you may also confuse your users!&lt;/p>
&lt;p>If you purge documents too quickly, they may get confused as to whether they created the report
or not, and may create it again, causing data problems. Users are not told that purging is
occurring in a very obvious way: the expectation is that purging will naturally occur as
documents become irrelevant, and so users should never really notice.&lt;/p>
&lt;p>Users may search for their own documents, and use data from them in novel ways you may not anticipate.
It&amp;rsquo;s important to work with your users to ensure documents are only removed once there are no uses
for them.&lt;/p>
&lt;p>It is key then, that you test your purge rules thoroughly!&lt;/p></description></item><item><title>Apps: CouchDB replication</title><link>https://docs.communityhealthtoolkit.org/beta/apps/guides/performance/replication/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://docs.communityhealthtoolkit.org/beta/apps/guides/performance/replication/</guid><description>
&lt;p>Replication is what we call it when users download a copy of the data on to their device.&lt;/p>
&lt;h2 id="restricting-replication">Restricting replication&lt;/h2>
&lt;p>If the user has an online role they can access all the data, otherwise they will get restricted access to the data.&lt;/p>
&lt;h3 id="restriction-by-place">Restriction by place&lt;/h3>
&lt;p>The most common restriction is by place. This is where we check the user&amp;rsquo;s &lt;code>facility_id&lt;/code> property, and allow access to all contacts that are descendants of that place, and all reports and messages that are about one of those descendants.&lt;/p>
&lt;p>For example, if a CHP&amp;rsquo;s &lt;code>facility_id&lt;/code> property is set to the ID of the Maori Hill clinic, then they will be able to see all patients and all reports about patients at that clinic.&lt;/p>
&lt;h3 id="depth">Depth&lt;/h3>
&lt;p>Sometimes though you want to only access contacts near the top of the hierarchy. This may be because returning all contacts would be too much data to be practical, or for patient privacy, or because it&amp;rsquo;s just not part of your workflow. In this case you can configure a replication depth for a specific role under &lt;code>replication_depth&lt;/code> in the app settings.&lt;/p>
&lt;p>For example:&lt;/p>
&lt;div class="highlight">&lt;pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-json" data-lang="json">&lt;span style="color:#000;font-weight:bold">{&lt;/span>
&lt;span style="color:#204a87;font-weight:bold">&amp;#34;replication_depth&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span> &lt;span style="color:#000;font-weight:bold">[&lt;/span>
&lt;span style="color:#000;font-weight:bold">{&lt;/span> &lt;span style="color:#204a87;font-weight:bold">&amp;#34;role&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;district_manager&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#204a87;font-weight:bold">&amp;#34;depth&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">1&lt;/span> &lt;span style="color:#000;font-weight:bold">},&lt;/span>
&lt;span style="color:#000;font-weight:bold">{&lt;/span> &lt;span style="color:#204a87;font-weight:bold">&amp;#34;role&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span> &lt;span style="color:#4e9a06">&amp;#34;national_manager&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">,&lt;/span> &lt;span style="color:#204a87;font-weight:bold">&amp;#34;depth&amp;#34;&lt;/span>&lt;span style="color:#000;font-weight:bold">:&lt;/span> &lt;span style="color:#0000cf;font-weight:bold">2&lt;/span> &lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;span style="color:#000;font-weight:bold">]&lt;/span>
&lt;span style="color:#000;font-weight:bold">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="supervisor-signoff">Supervisor signoff&lt;/h3>
&lt;p>Some reports need to be signed off by a supervisor even though that supervisor doesn&amp;rsquo;t have the depth to see the patient the report is about. To achieve this the report needs a field named &lt;code>needs_signoff&lt;/code> with a value of &lt;code>true&lt;/code>.&lt;/p>
&lt;h3 id="sensitive-documents">Sensitive documents&lt;/h3>
&lt;p>We won&amp;rsquo;t replicate documents that are about the user when the sender is someone the user can&amp;rsquo;t access. For example, if a supervisor submits a report about one of their CHPs, that CHP won&amp;rsquo;t be able to see it.&lt;/p></description></item><item><title>Apps: User telemetry</title><link>https://docs.communityhealthtoolkit.org/beta/apps/guides/performance/telemetry/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://docs.communityhealthtoolkit.org/beta/apps/guides/performance/telemetry/</guid><description>
&lt;p>&lt;em>Introduced in v3.4.0&lt;/em>&lt;/p>
&lt;p>The app collects performance data on certain user actions which is then aggregated over each calendar month and replicated to the server. This can be used to evaluate the performance of the code and configuration and to evaluate where improvements can be made.&lt;/p>
&lt;p>The aggregate doc for the previous month is created when the first telemetry item is recorded each month. This is stored in the &lt;code>medic-user-&amp;lt;username&amp;gt;-meta&lt;/code> database on the device and replicated to the server when an internet connection is available. This user specific server db is then replicated into the &lt;code>medic-users-meta&lt;/code> database which holds all aggregate telemetry docs for all users.&lt;/p>
&lt;p>The aggregate docs&amp;rsquo; IDs follow the pattern &lt;code>telemetry-&amp;lt;year&amp;gt;-&amp;lt;month&amp;gt;-&amp;lt;username&amp;gt;-&amp;lt;uuid&amp;gt;&lt;/code>.&lt;/p>
&lt;h2 id="performance-data">Performance data&lt;/h2>
&lt;p>Each aggregate data point has the following fields.&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Field&lt;/th>
&lt;th>Description&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;code>sum&lt;/code>&lt;/td>
&lt;td>A sum of all the recorded times in milliseconds.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>min&lt;/code>&lt;/td>
&lt;td>The smallest time recorded in milliseconds.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>max&lt;/code>&lt;/td>
&lt;td>The largest time recorded in milliseconds.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>count&lt;/code>&lt;/td>
&lt;td>The number of times recorded.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>sumsqr&lt;/code>&lt;/td>
&lt;td>The sum of squares of the times recorded in milliseconds.&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>The telemetry data gathered changes with different versions of the framework. Currently, the data points collected are:&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Field&lt;/th>
&lt;th>Description&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;code>boot_time&lt;/code>&lt;/td>
&lt;td>The overall boot time including loading the code, purging, and accessing the database.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>boot_time:1:to_first_code_execution&lt;/code>&lt;/td>
&lt;td>The time between the page loading and the JavaScript starting to run.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>boot_time:2:to_bootstrap&lt;/code>&lt;/td>
&lt;td>The time between JavaScript starting and the bootstrapping (purging, initial replication, etc) to complete.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>boot_time:3:to_angular_bootstrap&lt;/code>&lt;/td>
&lt;td>The time between bootstrapping completing and the webapp being ready to use.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>boot_time:4:to_db_warmed&lt;/code>&lt;/td>
&lt;td>The time between the webapp being ready to use and the database being ready to use.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>enketo:reports:&amp;lt;form&amp;gt;:&amp;lt;action&amp;gt;:&amp;lt;component&amp;gt;&lt;/code>&lt;/td>
&lt;td>The time taken to fill in Enketo forms. The &lt;code>action&lt;/code> can either be &amp;ldquo;add&amp;rdquo; or &amp;ldquo;edit&amp;rdquo;. The &lt;code>component&lt;/code> is one of: &amp;ldquo;render&amp;rdquo; covers getting the form and rendering it on screen; &amp;ldquo;user_edit_time&amp;rdquo; is the time the user took to fill in and submit the form; or &amp;ldquo;save&amp;rdquo; is about converting the form into a report and saving it.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>enketo:contacts:&amp;lt;form&amp;gt;:add:&amp;lt;component&amp;gt;&lt;/code>&lt;/td>
&lt;td>As above but for Contact creation forms.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>enketo:tasks:&amp;lt;form&amp;gt;:&amp;lt;action&amp;gt;:&amp;lt;component&amp;gt;&lt;/code>&lt;/td>
&lt;td>As above but for forms on the Tasks tab.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>search:contacts&lt;/code>&lt;/td>
&lt;td>The time taken to list all contacts.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>search:contacts:&amp;lt;filter[:filter]&amp;gt;&lt;/code>&lt;/td>
&lt;td>The time taken to search all contacts using the given filters.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>search:reports&lt;/code>&lt;/td>
&lt;td>The time taken to list all reports.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>search:reports:&amp;lt;filter[:filter]&amp;gt;&lt;/code>&lt;/td>
&lt;td>The time taken to search all reports using the given filters.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>client-date-offset&lt;/code>&lt;/td>
&lt;td>The difference between the client datetime and the server datetime. Only recorded if the difference is large enough that it may cause issues.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>analytics:targets:load&lt;/code>&lt;/td>
&lt;td>The time taken to load the targets page. Added in 3.9&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>tasks:load&lt;/code>&lt;/td>
&lt;td>The time taken to load the tasks page. Added in 3.9&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>tasks:refresh&lt;/code>&lt;/td>
&lt;td>The time taken to refresh tasks on the tasks page. Added in 3.9&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>rules-engine:initialize&lt;/code>&lt;/td>
&lt;td>The time taken to initialize the rules-engine . Added in 3.9&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>rules-engine:update-emissions&lt;/code>&lt;/td>
&lt;td>The time taken to update emissions in the rules-engine, when receiving a change. Added in 3.9&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>rules-engine:tasks:all-contacts&lt;/code>&lt;/td>
&lt;td>The time taken to fetch tasks for all contacts in rules-engine. Added in 3.9&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>rules-engine:tasks:some-contacts&lt;/code>&lt;/td>
&lt;td>The time taken to fetch tasks for some specific contacts in rules-engine. Added in 3.9&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>rules-engine:targets&lt;/code>&lt;/td>
&lt;td>Time taken for the rules-engine to fetch targets. Added in 3.9&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>rules-engine:targets:dirty-contacts&lt;/code>&lt;/td>
&lt;td>Number of &amp;ldquo;dirty&amp;rdquo; contacts[1] when fetching targets in the rules-engine. Added in 3.9&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>rules-engine:tasks:dirty-contacts&lt;/code>&lt;/td>
&lt;td>Number of &amp;ldquo;dirty&amp;rdquo; contacts[1] when fetching tasks in the rules-engine. Added in 3.9&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>rules-engine:ensureTaskFreshness:cancel&lt;/code>&lt;/td>
&lt;td>The time taken to cancel the automated task freshness thread in the rules-engine. This event is only recorded when the thread is cancelled before executing the refresh. Added in 3.9&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>rules-engine:ensureTargetFreshness:cancel&lt;/code>&lt;/td>
&lt;td>The time taken to cancel the automated target freshness thread in the rules-engine. This event is only recorded when the thread is cancelled before executing the refresh. Added in 3.9&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>[1] &amp;ldquo;Dirty&amp;rdquo; indicates that the contact&amp;rsquo;s task documents are not up to date. They will be refreshed before being used.&lt;/p>
&lt;h2 id="metadata">Metadata&lt;/h2>
&lt;p>When the aggregate doc is created the Telemetry service also includes a snapshot of some metadata.&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Field&lt;/th>
&lt;th>Description&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>&lt;code>year&lt;/code>&lt;/td>
&lt;td>The year the data was collected.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>month&lt;/code>&lt;/td>
&lt;td>The month the data was collected.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>user&lt;/code>&lt;/td>
&lt;td>The username of the logged in user.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>deviceId&lt;/code>&lt;/td>
&lt;td>A unique key for this device.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>versions.app&lt;/code>&lt;/td>
&lt;td>The version of the webapp.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>versions.forms.&amp;lt;form&amp;gt;&lt;/code>&lt;/td>
&lt;td>The version of each form.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>userAgent&lt;/code>&lt;/td>
&lt;td>The userAgent string from the user&amp;rsquo;s browser.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>hardwareConcurrency&lt;/code>&lt;/td>
&lt;td>The number of cores reported from the browser.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>screen.width&lt;/code>&lt;/td>
&lt;td>The width of the screen in pixels.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>screen.height&lt;/code>&lt;/td>
&lt;td>The height of the screen in pixels.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>deviceInfo.app.version&lt;/code>&lt;/td>
&lt;td>The version of the Android app.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>deviceInfo.software.androidVersion&lt;/code>&lt;/td>
&lt;td>The version of Android OS.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>deviceInfo.software.osApiLevel&lt;/code>&lt;/td>
&lt;td>The API of the Android OS.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>deviceInfo.software.osVersion&lt;/code>&lt;/td>
&lt;td>The version of Android OS (detailed).&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>deviceInfo.hardware.device&lt;/code>&lt;/td>
&lt;td>The Android device name.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>deviceInfo.hardware.model&lt;/code>&lt;/td>
&lt;td>The Android model name.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>deviceInfo.hardware.manufacturer&lt;/code>&lt;/td>
&lt;td>The Android device manufacturer.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>deviceInfo.hardware.hardware&lt;/code>&lt;/td>
&lt;td>The Android device hardware.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>deviceInfo.hardware.cpuInfo&lt;/code>&lt;/td>
&lt;td>The Android device CPU information.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>deviceInfo.storage.free&lt;/code>&lt;/td>
&lt;td>The available storage on the device.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>deviceInfo.storage.total&lt;/code>&lt;/td>
&lt;td>The total storage on the device.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>deviceInfo.ram.free&lt;/code>&lt;/td>
&lt;td>The available RAM on the device.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>deviceInfo.ram.total&lt;/code>&lt;/td>
&lt;td>The total RAM on the device.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>deviceInfo.ram.threshold&lt;/code>&lt;/td>
&lt;td>The level of RAM at which certain services will be killed by Android.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>deviceInfo.network.downSpeed&lt;/code>&lt;/td>
&lt;td>The reported download speed of the network.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>deviceInfo.network.upSpeed&lt;/code>&lt;/td>
&lt;td>The reported upload speed of the network.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>dbInfo.doc_count&lt;/code>&lt;/td>
&lt;td>The number of docs in the local database.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>dbInfo.update_seq&lt;/code>&lt;/td>
&lt;td>The update sequence of the local database.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>dbInfo.idb_attachment_format&lt;/code>&lt;/td>
&lt;td>The format of database attachments.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>dbInfo.db_name&lt;/code>&lt;/td>
&lt;td>The name of the local database.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>dbInfo.auto_compaction&lt;/code>&lt;/td>
&lt;td>Whether or not auto compaction is set.&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>&lt;code>dbInfo.adapter&lt;/code>&lt;/td>
&lt;td>The database adapter being used.&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table></description></item></channel></rss>